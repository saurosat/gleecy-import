<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns=""
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="Import Products" default-menu-index="7" standalone="false"
        require-authentication="anonymous-all">

    <transition name="uploadProductCSV">
        <service-call name="gleecy.import.ProductImportServices.importCsv" out-map="resultMap"/>
        <default-response url="."/>
    </transition>
    <transition name="createProductTemplate">
        <service-call name="create#gleecy.import.ProductTemplate" />
        <default-response url="."/>
    </transition>
    <transition name="selectTemplate">
        <default-response url="."/>
    </transition>
    <actions>
        <entity-find entity-name="gleecy.import.ProductTemplate" list="templateList" />
        <set field="something" from="templateId" />
        <iterate list="templateList" entry="template">
            <if condition="template.templateId == templateId">
                <set field="selectedTemplate" from="template" />
                <break/>
            </if>
        </iterate>

        <set field="configuredFieldNames" from="[ 'pseudoId', 'productTypeEnumId', 'productClassEnumId']" />
        <set field="fieldNames" from="[]" />
        <script>
            import org.moqui.entity.EntityValue
            import org.moqui.impl.entity.EntityDefinition

            EntityDefinition ed = ec.getEntity().getEntityDefinition("mantle.product.Product")
            List nonPkFNames = ed.getNonPkFieldNames()
            nonPkFNames.remove("lastUpdatedStamp")
            nonPkFNames.removeAll(configuredFieldNames)

            for (String fName : nonPkFNames) {
                fieldNames.add(fName)
                //fieldNames.add([fieldName: fName, text: "Field " + fName])
            }
        </script>

        <iterate list="fieldNames" entry="tName">
            <log message="${tName}" />
        </iterate>
    </actions>

    <widgets>
        <container-row>
            <row-col>
                <form-single name="SelectTemplate" transition="selectTemplate" >
                    <field name="test">
                        <default-field title="Test">
                            <drop-down>
                                <option key="_NA_" text="N/A"/>
                                <list-options list="fieldNames"/>
                            </drop-down>
                        </default-field>
                    </field>
                    <field name="templateId">
                        <default-field title="Product Import Template">
                            <drop-down submit-on-select="true">
                                <option key="_NA_" text="N/A"/>
                                <list-options list="templateList" key="${templateId}"  text="${templateName}" />
                            </drop-down>
                        </default-field>
                    </field>
                </form-single>
            </row-col>
            <row-col>
                <container type="div" style="q-my-md"><container type="div" style="q-ma-sm">
                    <container-dialog id="NewTemplateDialog" button-text="${selectedTemplate == null ? 'New Import Template' : 'Edit Template Details'}">
                    <form-single name="NewTemplateForm" transition="createProductTemplate" map="selectedTemplate">
                        <auto-fields-entity entity-name="gleecy.import.ProductTemplate" include="nonpk" field-type="edit"/>
                        <field name="submitButton">
                            <default-field title="Submit">
                                <submit/></default-field></field>
                    </form-single>
                    </container-dialog>
                </container></container>
            </row-col>
        </container-row>

        <container-row>
            <row-col>
                <form-single name="UploadCSV" transition="uploadProductCSV" >
                    <field name="templateId" from="templateId"><default-field>
                        <hidden />
                    </default-field></field>
                    <field name="csvFile" hide="selectedTemplate == null"><default-field title="Upload CSV"><file/></default-field></field>
                    <field name="submitButton" hide="selectedTemplate == null">
                        <default-field title="Upload">
                            <submit/></default-field></field>
                </form-single>
            </row-col>
        </container-row>

    </widgets>
</screen>